<script>	
	function sendMessage () {

		// Get the user to send the message to and the message to send
		to_user = document.getElementById("to_user").value;
		content = document.getElementById("content").value;

		// Check if the user exists
		if (userExists(to_user)) {

			// Create a new variable to hold request
			var sendMessageRequest;

			// Check if XMLHttpRequest exists (modern browsers - IE7+, Firefox, Chrome, Opera, Safari)
			if (window.XMLHttpRequest) {
				// if it does create a XMLHttpRequest
				sendMessageRequest = new XMLHttpRequest();
			}
			else {
				// otherwise deal with IE6, IE5
				sendMessageRequest=new ActiveXObject("Microsoft.XMLHTTP");
			}

			// Call back function for request
			sendMessageRequest.onreadystatechange=function() {

				// Check if request was sent successfully.
				if (sendMessageRequest.readyState==4 && sendMessageRequest.status==200) {

					// Get response body
					var json = sendMessageRequest.responseText;

					// Parse into JSON
				    json = JSON.parse(json);
				    console.log(json.result == true);

				    // Check if result is true
				    if (json.result == true) {
				    	alert("Sent.")
				    } else {
				    	alert("Error.")
				    }

				    // Clear the text box
				    $("#content").val("");

				}
			}

			// Send a post request
			sendMessageRequest.open("POST","{{ url_for("new_message") }}",true);
			sendMessageRequest.setRequestHeader("Content-type","application/x-www-form-urlencoded");
			sendMessageRequest.send("to_user=" + to_user + "&content=" + content);
		}

		else {
			// Tell the user that user they want to send a message to does not exist
			alert("User does not exist.");
		}
	}

	// Function to get messages send to and recieved from a user
	function getMessagesOnClick (from_user) {

		// Check if user exists (should do as list of users generated by server)
		if (userExists(from_user)) {
			
			// Create variable to hold request
			var getMessagesRequest;

			// Check if XMLHttpRequest exists (modern browsers - IE7+, Firefox, Chrome, Opera, Safari)
			if (window.XMLHttpRequest) {
				//  if it does create a XMLHttpRequest
				getMessagesRequest = new XMLHttpRequest();
			}
			else {
				// otherwise deal with IE6, IE5
				getMessagesRequest = new ActiveXObject("Microsoft.XMLHTTP");
			}

			// Callback function
			getMessagesRequest.onreadystatechange=function() {

				// Check if request successful
				if (getMessagesRequest.readyState==4 && getMessagesRequest.status==200) {

					// Get response body
					var json = getMessagesRequest.responseText;

					// Parse into JSON
				    json = JSON.parse(json);

				    // Create variable to hold all li element strings
				    var listString = "";

				    // Iterate through messages
					for (var i = 0; i < json.length; i++) {

						// Get a message
						var message = json[i];

						// Get the sender of message and the content of the message
						var sent_from = message[2];
						var content = message[1];

						// Create variable to store CSS class for li element
						var css_class;

						// Check if the other person sent it 
						if (from_user == sent_from) {
							// If so add css class other_sent_it
							css_class = "other_sent_it";
						}
						else {
							// Else if the user sent it add classes i_sent_it
							css_class = "i_sent_it";
						}

						// Create the string for li element with css_class and content
						var listItemString = '<li class="' + css_class + '">' + content + '</li>';

						// Append listItemString to listString
						listString += listItemString;
					}
					var messages = document.getElementById("messages");
					var user_to_fetch = document.getElementById("user_to_fetch");
					user_to_fetch.value = from_user;
					messages.innerHTML = listString;
					$("#messages").scrollTop(0);
				}
			}

			// Send Post Request
			getMessagesRequest.open("POST","{{ url_for("get_messages_from") }}",true);
			getMessagesRequest.setRequestHeader("Content-type","application/x-www-form-urlencoded");
			getMessagesRequest.send("from_user=" + from_user);

		} else {
			// Else tell the user that user does not exist.
			alert("User does not exist.");
		}
	}

	// Modify contains function to work on all browers
	Array.prototype.contains = function ( needle ) {
	   for (i in this) {
	       if (this[i] == needle) return true;
	   }
	   return false;
	}

	// Function to check if user exists
	function userExists (username) {
		// Create array to store users
		var users = []

		// Use templating to iterate through users
		{% for user in users %}
			// Add user to array
			users.push("{{ user }}");
		{% endfor %}

		// Check if username is in array
		return users.contains(username);

	}	
</script>